<script type="text/html" data-template-name="tuya-local-device">
  <div class="form-row">
    <ul id="node-config-input-tuya-tabs"></ul>
  </div>
  <div id="node-config-input-tabs-content">
    <div id="tuya-settings-tab" style="display:none">
      <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
      </div>
      <div class="form-row">
        <label for="node-config-input-project"><i class="fa fa-dot-circle-o"></i> Project</label>
        <input type="text" id="node-config-input-project">
      </div>
      <div class="form-row">
        <label for="node-config-input-deviceId"><i class="fa fa-tag"></i> ID</label>
        <input type="text" id="node-config-input-deviceId">
      </div>
      <div class="form-row">
        <label for="node-config-input-netType"><i class="fa fa-wrench"></i> Net type</label>
        <select name="node-config-input-netType" id="node-config-input-netType">
          <option value="" selected disabled hidden>Auto</option>
          <option value="0">Auto</option>
          <option value="1">IP device</option>
          <option value="2">Gateway</option>
          <option value="3">GW Client</option>
        </select>
      </div>
      <div id="tuya-wifi-client">
        <div class="form-row">
          <label for="node-config-input-gateway"><i class="fa fa-tag"></i> Gateway</label>
          <input type="text" id="node-config-input-gateway">
        </div>
        <div class="form-row">
          <label for="node-config-input-cid"><i class="fa fa-tag"></i> Node uuid</label>
          <input type="text" id="node-config-input-cid">
        </div>
      </div>
      <div id="tuya-wifi-device">
        <div class="form-row">
          <label for="node-config-input-localKey"><i class="fa fa-tag"></i> Local key</label>
          <input type="text" id="node-config-input-localKey">
        </div>
        <div class="form-row">
          <label for="node-config-input-autoStart"><i class="fa fa-tag"></i> Auto connect</label>
          <input type="checkbox" id="node-config-input-autoStart">
        </div>
        <div class="form-row">
          <label for="node-config-input-cacheAnnouncement"><i class="fa fa-tag"></i> Cache announcement</label>
          <input type="checkbox" id="node-config-input-cacheAnnouncement">
        </div>
        <div class="form-row">
          <label for="node-config-input-deviceMac"><i class="fa fa-tag"></i> MAC address</label>
          <input type="text" id="node-config-input-deviceMac">
        </div>
        <div class="form-row">
          <label for="node-config-input-staticIp"><i class="fa fa-tag"></i> Static IP</label>
          <input type="checkbox" id="node-config-input-staticIp">
        </div>
        <div class="form-row">
          <label for="node-config-input-ip"><i class="fa fa-tag"></i> IP address</label>
          <input type="text" id="node-config-input-ip" readonly>
          <a id="node-config-input-web" href="" target="_blank"> Web</a>
        </div>
        <div class="form-row">
          <label for="node-config-input-port"><i class="fa fa-tag"></i> Port</label>
          <input type="text" id="node-config-input-port">
        </div>
      </div>
      <!-- <div class="form-row">
        <label for="node-config-input-fullTopic"><i class="fa fa-wrench"></i> MQTT topic</label>
        <input type="text" id="node-config-input-fullTopic">
      </div> -->
    </div>
    <div id="tuya-dps-tab" style="display:none">
      <div class="form-row">
        <table id="dps-table" class="table table-hover" style="border:1px solid;border-collapse:collapse;width:100%">
          <thead>
            <tr id="table-head">
              <th style="text-align:left;width:10%"><input type="text" value="Id" style="width:100%" readonly></th>
              <th style="text-align:left;width:30%"><input type="text" value="Code" style="width:100%" readonly></th>
              <th style="text-align:left"><input type="text" value="Name" style="width:100%" readonly></th>
              <th style="width:20%"><input type="text" value="Type" style="width:100%" readonly></th>
              <th style="width:10%"><input type="text" value="Mode" style="width:100%" readonly></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="tuya-extension-tab" style="display:none">
      <!-- TODO -->
    </div>
    <div id="tuya-advanced-tab" style="display:none">
      <div class="form-row">
        <label for="node-config-input-deviceCategory"><i class="fa fa-wrench"></i> Device category</label>
        <input type="text" id="node-config-input-deviceCategory">
      </div>
      <div class="form-row">
        <label for="node-config-input-tuyaVersion"><i class="fa fa-wrench"></i> Tuya protocol version</label>
        <input type="text" id="node-config-input-tuyaVersion">
      </div>
      <div class="form-row">
        <label for="node-config-input-retryTimeout"><i class="fa fa-wrench"></i> Retry timeout (ms)</label>
        <input type="number" id="node-config-input-retryTimeout">
      </div>
      <div class="form-row">
        <label for="node-config-input-findTimeout"><i class="fa fa-wrench"></i> Find timeout (ms)</label>
        <input type="number" id="node-config-input-findTimeout">
      </div>
      <div class="form-row">
        <label for="node-config-input-eventMode"><i class="fa fa-wrench"></i> Tuya events to listen</label>
        <select name="node-config-input-eventMode" id="node-config-input-eventMode">
          <option value="" disabled hidden>Both Events</option>
          <option value="event-data">Data Event</option>
          <option value="event-dp-refresh">DP-Refresh Event</option>
          <option value="event-both">Both Events</option>
        </select>
      </div>
      <div class="form-row">
        <label for="node-config-input-reinitOnLost"><i class="fa fa-wrench"></i> Reinit on lost connection</label>
        <input type="checkbox" id="node-config-input-reinitOnLost">
      </div>
    </div>
    <div id="tuya-project-misc-tab" style="display:none">
      <fieldset>
        <legend>Debug output in terminal</legend>
        <div class="form-row">
          <input type="checkbox" id="node-config-input-dbgDevice" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-config-input-dbgDevice" style="width: auto">Device</label>
        </div>
        <div class="form-row">
          <input type="checkbox" id="node-config-input-dbgDeviceExtension" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-config-input-dbgDeviceExtension" style="width: auto">Device extension</label>
        </div>
        <div class="form-row">
          <input type="checkbox" id="node-config-input-dbgTuyaDevice" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-config-input-dbgTuyaDevice" style="width: auto">Local connection</label>
        </div>
      </fieldset>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="tuya-local-device">
</script>

<script type="text/javascript">
  RED.nodes.registerType('tuya-local-device', {
    category: 'config',
    defaults: {
      // node specific
      // Settings tab
      name: { value: '', required: true },
      project: { type: 'tuya-project', required: true },
      deviceId: { value: '', required: true },
      localKey: { value: '' },
      netType: { value: 0 },
      gateway: { type: 'tuya-local-device', required: false },
      cid: { value: '' },
      autoStart: { value: true, required: true },
      cacheAnnouncement: { value: true, required: true },
      deviceMac: { value: '' },
      staticIp: { value: false },
      ip: { value: '' },
      port: { value: 6668 },
      //not configurable
      home: { value: '' },
      room: { value: '' },
      // Advanced tab
      deviceCategory: { value: '' },
      tuyaVersion: { value: '' },
      retryTimeout: { value: 1000, required: true }, //validate: RED.validators.number() },
      findTimeout: { value: 10000, required: true }, // validate: RED.validators.number() },
      reinitOnLost: { value: false },
      eventMode: { value: 'event-both', required: true },
      // MISC tab
      dbgDevice: { value: false },
      dbgDeviceExtension: { value: false },
      dbgTuyaDevice: { value: false },
    },
    label: function() { 
      // use label callback to perform init
      if (!this.init) {
        this.getCloudDevice = (callback => {
          if (this._device) return callback(this._device)
          if (!this.project) return console.error('project not configured: ' + this.project)
          const project = RED.nodes.node(this.project)
          if (!project) return console.error('project not found: ' + this.project)
          if (this.home === undefined) this.home = project.home || ''
          if (this.room === undefined) this.room = project.room || ''
          project.getCloudDevices && project.getCloudDevices(cloudDevices => {
            if (!cloudDevices) return console.error('download devices failed')
            this._device = cloudDevices[this.deviceId]
            if (!this._device) {
              console.error(`Cloud device not found ${this.deviceId}, available: ${Object.keys(cloudDevices)}`)
            }
            callback(this._device)
          })
        })
        this.getProperties = (callback => {
          if (this._properties) return callback(this._properties)
          this.getCloudDevice(device => {
            this._properties = []
            if (device?.productId) {
              this.isBusinessModel = true
              if (!this.project) return console.error('project not configured: ' + this.project)
              const project = RED.nodes.node(this.project)
              project.getSchemas && project.getSchemas(schemas => {
                const schema = schemas && schemas[device.productId]?.schemaInfo?.schema
                if (typeof schema === 'object') {
                  this._properties = Object.values(schema)
                }
              })
            }
            else if (device?.dataModel) {
              this.isBusinessModel = false
              const project = RED.nodes.node(this.project)
              project.getModels && project.getModels(models => {
                const services = models[device?.dataModel]
                if (Array.isArray(services)) {
                  for (const service of services) {
                    if (!Array.isArray(service.properties)) continue
                    for (const property of service.properties) {
                      this._properties.push(property)
                    }
                  }
                }
              })
            }
            return callback(this._properties)
          })
        })
        this.getOverloads = (callback => {
          if (this._overloads) return callback(this._overloads)
          this._overloads = {}
          this.getCloudDevice(device => {
            const project = RED.nodes.node(this.project)
            project.getOverloads && project.getOverloads(overloads => {
              if (overloads && overloads.models) {
                if (device.productId) {
                  this._overloads = overloads.schemas[device.productId]
                  //TODO
                }
                else if (device.dataModel) {
                  this._overloads = overloads.models[device.dataModel]
                }
              }
              callback(this._overloads)
            })
          })
        })
        this.getRanges = (callback => {
          if (this._ranges) return callback(this._ranges)
          this.getProperties(properties => {
            this._ranges = {}
            if (Array.isArray(properties)) {
              for (const prop of properties) {
                const propRange = this.isBusinessModel ? prop.property?.range : prop.typeSpec?.range
                if (propRange) {
                  const range = {}
                  for (let i = 0; i < propRange.length; i++) {
                    range[i] = propRange[i]
                  }
                  this._ranges[prop.code] = range
                }
              }
            }
            this.getOverloads(overloads => {
              if (overloads.ranges) this._ranges = Object.assign(this._ranges, overloads.ranges)
              callback(this._ranges)
            })
          })
        })
        this.getContext = (callback => {
          if (this._context) return callback(this._context)
          this.getCloudDevice(device => {
            if (!device.category) return callback(null)
            const category = device.category
            const project = RED.nodes.node(this.project)
            project.getContext && project.getContext(context => {
              if (!context) return callback(null)
              if (!context.category) {
                // look for device in all categories
                for (const categoryContext of Object.values(context)) {
                  if (categoryContext[this.deviceId]) {
                    this._context = categoryContext[this.deviceId]
                    return callback(this._context)
                  }
                }
                return callback(null)
              }
              if (!context.category.hasOwnProperty(this.deviceId)) return callback(null)
              this._context = context.category[this.deviceId]
              callback(this._context)
            })
          })
        })
        this.init = true
      }
      return this.name || 'Tuya Device' 
    },
    oneditprepare: function () {
      const tabs = RED.tabs.create({
        id: 'node-config-input-tuya-tabs',
        onchange: function (tab) {
          $('#node-config-input-tabs-content').children().hide()
          $('#' + tab.id).show()
        }
      })
      tabs.addTab({ id: 'tuya-settings-tab', label: 'Settings' })
      tabs.addTab({ id: 'tuya-dps-tab', label: 'DataPoints' })
      tabs.addTab({ id: 'tuya-advanced-tab', label: 'Advanced' })
      tabs.addTab({ id: 'tuya-project-misc-tab', label: 'MISC' })
      let tabExtensionExists = false

      if (!this.retryTimeout) $('#node-config-input-retryTimeout').val(1000)
      if (!this.findTimeout) $('#node-config-input-findTimeout').val(10000)

      if (!parseInt(this.netType)) {
        //recognize device net type
        const gateway = $('#node-config-input-gateway').val()
        if (this.gateway || gateway && (gateway !== '_ADD_')) this.netType = '3' // GW client
        $('#node-config-input-netType').val(this.netType)
      }
      //TODO use netType
      // Business app data model
      // All: has [id, activeTime, category, categoryCode, devAttribute, devId (== id), dpMaxTime, dpName, iconUrl, localKey, moduleMap, naem, productId, runtimeEnv, timezoneId, uuid, virtual], hasn't [devKey], optional: [lat, lon, mac, skills]
      // 1: IP device: has [ip]
      // 2: Gateway: has [ip, meshId, nodeId, topoType], topoType=0
      // 3: GW client: has [meshId, nodeId, topoType], topoType=1
      // Smart app data model
      // All: has [id, active_time, category, category_name, create_time, local_key, name, online, owner_id, product_id, product_name, sub, time_zone, update_time, uuid, dataModel], optional: [lat, lon, model],
      //  intern [deviceId, localKey, name, cloudDevice]
      // 1: IP device: has [ip], hasn't [gateway, cid], sub=false
      // 2: Gateway: has [ip], sub=true
      // 3: GW client: has [gateway_id, node_id], sub=true

      // show/hide config block for wifi devices
      const refreshGateway = () => {
        const gateway = $('#node-config-input-gateway').val()
        if (this.netType == '3') { // GW client
          $('#tuya-wifi-device').hide()
          $('#tuya-wifi-client').show()
        }
        else {
          $('#tuya-wifi-device').show()
          $('#tuya-wifi-client').hide()
        }
      }
      $('#node-config-input-gateway').on('change', refreshGateway)

      if (this.staticIp) $('#node-config-input-ip').removeAttr('readonly')
      $('#node-config-input-staticIp').on('change', () => {
        if ($('#node-config-input-staticIp').is(':checked')) {
          $('#node-config-input-ip').removeAttr('readonly')
        }
        else {
          $('#node-config-input-ip').attr('readonly','readonly')
        }
      })

      const updateDpsTable = (properties) => {
        const el = $('#dps-table > tbody')
        el.html('')
        const ilist = []
        if (Array.isArray(properties)) {
          for (const prop of properties) {
            const id = prop.id || prop.abilityId
            const mode = prop.mode || prop.accessMode
            const typeSpec = prop.property || prop.typeSpec
            ilist.push(`
              <tr>
                <td><input type="text" value="${id}" style="width:100%" readonly></td>
                <td><input type="text" value="${prop.code}" style="width:100%" readonly></td>
                <td><input type="text" id="dps-${this.deviceId}-${id}" value="${prop._custom_name || prop.name || ''}" title="${prop._custom_description || prop.description || ''}" style="width:100%" readonly></td>
                <td><input type="text" value="${typeSpec && typeSpec.type || ''}" title='${typeSpec && JSON.stringify(typeSpec, null, 2) || ''}' style="width:100%" readonly></td>
                <td><input type="text" value="${mode}" style="width:100%" readonly></td>
              </tr>`)
          }
        }
        el.append(ilist.join(''))
      }

      const updateExtTable = (context) => {
        const data = Object.values(context).find(value => (typeof value === 'object') && (value !== null)) || {}
        const labels = ['id'].concat(Object.keys(data))

        const div = document.createElement('div')
        div.className = 'form-row'

        const table = document.createElement('table')
        table.id = 'dps-table'
        table.className = 'table table-hover'
        table.style.border = '1px solid'
        table.style.borderCollapse = 'collapse'
        table.style.width = '100%'

        const thead = document.createElement('thead')
        const tr = document.createElement('tr')
        tr.id = 'table-head'

        const th = document.createElement('th')
        //th.style.textAlign = 'left'
        //th.style.width = '10%'

        const input = document.createElement('input')
        input.type = 'text'
        input.value = 'Id' //??
        input.style.width = '100%'
        input.readOnly = true

        th.appendChild(input)
        tr.appendChild(th)
        thead.appendChild(tr)

        const tbody = document.createElement('tbody')

        table.appendChild(thead)
        table.appendChild(tbody)
        div.appendChild(table)

        return div
      }

      const updateExtension = (context) => {
        const tabId = 'tuya-extension-tab'
        const el = $('#tuya-extension-tab')
        if (!context) {
          el.html('')
          if (tabExtensionExists) {
            tabs.removeTab(tabId)
            tabExtensionExists = false
          }
          return
        }
        
        if (!tabExtensionExists) {
          tabs.addTab({ id: tabId, label: 'SubDevices' })
          tabExtensionExists = true
        }
        const getContextTabs = () => {
          for (const item of Object.values(context)) {
            if (typeof item === 'object') {
              const extTabs = Object.keys(item)
              const subItem = extTabs.length && item[extTabs[0]]
              if (subItem && (typeof subItem === 'object') && subItem.hasOwnProperty('selection')) {
                return { data: item, selection: context.selection, code: context.code }
              }
            }
          }
        }
        
        this.getRanges((ranges) => {
          const contextTabs = getContextTabs()
          if (contextTabs) {
            // <div class="form-row">
            //   <ul id="tuya-extension-tabs"></ul>
            // </div>
            // <div class="form-row" id="tuya-extension-view"></div>
            const tabsRow = document.createElement('div')
            tabsRow.className = 'form-row'
            const ul = document.createElement('ul')
            ul.id = 'tuya-extension-tabs'
            tabsRow.appendChild(ul)
            el[0].appendChild(tabsRow)

            const tableRow = document.createElement('div')
            tableRow.className = 'form-row'
            tableRow.id = 'tuya-extension-view'
            el[0].appendChild(tableRow)
            // ****************************
            const extTabs = RED.tabs.create({
              id: 'tuya-extension-tabs',
              onchange: function (tab) {
                $('#tuya-extension-view').children().hide()
                $('#' + tab.id).show()
              }
            })
            const range = contextTabs.code && ranges[contextTabs.code] || {}
            for (const tab of Object.keys(contextTabs.data)) {
              const label = range[tab] || ('Category' + tab)
              const tabId = 'tuya-extension-tab' + tab
              extTabs.addTab({ id: tabId, label})

              const elExtView = $('#tuya-extension-view')
              elExtView.html('')

              const tableDiv = document.createElement('div')
              tableDiv.id = tabId
              tableDiv.style.display = 'none'
              const table = updateExtTable(contextTabs.data[tab])
              if (table) tableDiv.appendChild(table)

              elExtView[0].appendChild(tableDiv)
            }
          }
          else {
            //TODO
          }
        })
      }

      const updateWidgets = () => {
        this.getProperties(properties => {
          if (!Array.isArray(properties)) {
            console.warn('device properties has no data model')
            return
          }
          updateDpsTable(properties)
        })
        this.getContext(context => updateExtension(context))
      }

      const fillDeviceProperties = () => {
        this.getCloudDevice(cloudDevice => {
          if (!cloudDevice) return console.error('[local device] device not found')
          if (!this.deviceCategory) {
            this.deviceCategory = cloudDevice.category
            $('#node-config-input-deviceCategory').val(this.deviceCategory)
          }
          updateWidgets()
        })
      }

      //refreshGateway()
      fillDeviceProperties()
      const project = RED.nodes.node(this.project)
      this.deviceMac && this.tuyaVersion || project?.getAnnouncements(announcements => {
        const announcement = announcements?.[this.deviceId]
        this.deviceMac = this.deviceMac || announcement?.mac || ''
        this.tuyaVersion = announcement?.version || this.tuyaVersion|| ''
        $('#node-config-input-deviceMac').val(this.deviceMac)
        $('#node-config-input-tuyaVersion').val(this.tuyaVersion)
        this.ip = announcement?.ip || this.ip || ''
        $('#node-config-input-ip').val(this.ip)
        if (this.ip) $('#node-config-input-web').show()
        else $('#node-config-input-web').hide()
        $('#node-config-input-web').attr('href', this.ip && ('http://' + this.ip) || '') 
      })
    },
    oneditsave: function() {
      const project = RED.nodes.node(this.project)
      // add new properties in existing nodes for compatibility
      if (this.home === undefined) this.home = project?.home || ''
      if (this.room === undefined) this.room = project?.room || ''
      if (this.cacheAnnouncement === undefined) this.cacheAnnouncement = true
      if (this.tuyaVersion === undefined) this.tuyaVersion = ''
      if (this.deviceMac === undefined) this.deviceMac = ''
      this.deviceMac && this.tuyaVersion || project?.getAnnouncements(announcements => {
        const announcement = announcements?.[this.deviceId]
        this.deviceMac = this.deviceMac || announcement?.mac || ''
        this.deviceCategory = this.deviceCategory || ''
      })
      if (this.staticIp === undefined) this.staticIp = false
    }
  })
</script>
